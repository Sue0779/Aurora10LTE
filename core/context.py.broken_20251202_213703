import json, sys, logging
from pathlib import Path

# --- KLUCZOWO: IMPORTY PAKIETOWE ---
from core.ai_primary import AIPRIMARY
from core.fs_api import FSAPI
from core.exec_api import ExecAPI

class AuroraContext:
    def __init__(self, root):
        self.root = Path(root)
        self.commands = {}
        self.log = self._setup_logger()

        # Profil
        self.profile_path = self.root / "profiles" / "default.profile.json"
        self.profile = self._load_profile()

        # Ustawianie ścieżek
        self._patch_sys_path()

        # Podsystemy
        self.ai = AIPRIMARY(self)
        self.fs = FSAPI(self)
        self.exec = ExecAPI(self)

    def _patch_sys_path(self):
        # Importy pakietowe wymagają obecności ścieżki ROOT
        root = str(self.root)
        if root not in sys.path:
            sys.path.insert(0, root)

        core = str(self.root / "core")
        if core not in sys.path:
            sys.path.insert(0, core)

        plugins = str(self.root / "plugins")
        if plugins not in sys.path:
            sys.path.insert(0, plugins)

    def _setup_logger(self):
        log_path = self.root / "logs" / "aurora.log"
        logger = logging.getLogger("Aurora")
        logger.setLevel(logging.INFO)
        if not logger.handlers:
            fh = logging.FileHandler(log_path)
            formatter = logging.Formatter("%(asctime)s [%(levelname)s] %(message)s")
            fh.setFormatter(formatter)
            logger.addHandler(fh)
        return logger

    def _load_profile(self):
        if not self.profile_path.exists():
            return {}
        try:
            return json.loads(self.profile_path.read_text())
        except Exception:
            return {}

    def register_command(self, name, handler, help_text="", group="core"):
        self.commands[name] = {
            "handler": handler,
            "help": help_text,
            "group": group
        }
